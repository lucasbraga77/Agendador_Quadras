<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendador de Quadras</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container">
    <h1>‚ö° Agendador de Quadras</h1>
    
    <!-- SELETOR DE MODO -->
    <div class="modo-selector">
        <button class="modo-btn" data-modo="agendado" onclick="selectModo('agendado')">
            <span class="emoji">ü§ñ</span>
            <span class="titulo">Agendamento Autom√°tico</span>
            <span class="desc">Programa para amanh√£ √†s 14h</span>
        </button>
        <button class="modo-btn" data-modo="reserva" onclick="selectModo('reserva')">
            <span class="emoji">‚ö°</span>
            <span class="titulo">Reservar Agora</span>
            <span class="desc">Tenta agendar imediatamente</span>
        </button>
    </div>

    <!-- FORMUL√ÅRIO -->
    <div class="form-section">
        <div class="input-group">
            <input id="user" type="text" placeholder="Usu√°rio" required>
        </div>
        
        <div class="input-group">
            <input id="senha" type="password" placeholder="Senha" required>
        </div>

        <div class="input-group">
            <input id="matricula" type="text" placeholder="Matr√≠cula" required>
        </div>

        <div class="input-group" id="data-container" style="display: none;">
            <input id="data" type="date" placeholder="Data">
            <small id="data-hint">Selecione a data desejada</small>
        </div>
    </div>

    <!-- QUADRAS -->
    <div class="section">
        <h3>üéæ Quadras</h3>
        <div id="quadras" class="checkbox-grid">
            <label class="checkbox-label">
                <input type="checkbox" value="PADEL-1">
                <span>PADEL-1</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="PADEL-2">
                <span>PADEL-2</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="PADEL-3">
                <span>PADEL-3</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="PADEL-4">
                <span>PADEL-4</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="PADEL-5">
                <span>PADEL-5</span>
            </label>
        </div>
    </div>

    <!-- HOR√ÅRIOS -->
    <div class="section">
        <h3>üïê Hor√°rios</h3>
        <div id="horarios" class="checkbox-grid horarios-grid">
            <label class="checkbox-label">
                <input type="checkbox" value="09:30">
                <span>09:30</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="10:45">
                <span>10:45</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="12:00">
                <span>12:00</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="13:15">
                <span>13:15</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="14:30">
                <span>14:30</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="15:45">
                <span>15:45</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="17:00">
                <span>17:00</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="18:15">
                <span>18:15</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="19:30">
                <span>19:30</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" value="20:45">
                <span>20:45</span>
            </label>
        </div>
    </div>

    <!-- BOT√ïES -->
    <div class="actions">
        <button class="btn-primary" onclick="start()" id="btn-start" disabled>
            <span id="btn-text">Selecione um modo</span>
        </button>
        <button class="btn-cancel" onclick="cancel()">
            ‚èπ Cancelar
        </button>
    </div>

    <!-- LOG -->
    <div class="log-section">
        <h3>üìã Log de Execu√ß√£o</h3>
        <pre id="log"></pre>
    </div>

    <!-- CONSULTA DE QUADRAS -->
    <div class="log-section">
        <h3 style="cursor: pointer; user-select: none;" onclick="toggleConsulta()">
            üéæ Consultar Quadras Ocupadas 
            <span id="toggle-icon" style="float: right;">‚ñº</span>
        </h3>
        <div id="consulta-section" style="display: none;">
            <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <input type="date" id="consulta-data" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-right: 10px; font-size: 14px;">
                <button onclick="consultarQuadras()" style="padding: 8px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    Buscar
                </button>
                <small style="display: block; margin-top: 10px; color: #6b7280;">
                    üí° Preencha as credenciais.
                </small>
                <div id="login-extra" style="display: none; margin-top: 10px;">
                    <input type="text" id="consulta-user" placeholder="Usu√°rio" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-right: 5px; width: 150px;">
                    <input type="password" id="consulta-senha" placeholder="Senha" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; width: 150px;">
                </div>
            </div>
            <div id="tabela-quadras"></div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <small>Developed by Lucas Braga | Vers√£o Web 2.0</small>
    </div>
</div>

<script>
let modoAtual = null;

function selectModo(modo) {
    modoAtual = modo;
    
    // Atualiza bot√µes
    document.querySelectorAll('.modo-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-modo="${modo}"]`).classList.add('active');
    
    // Mostra/esconde campo de data
    const dataContainer = document.getElementById('data-container');
    const dataHint = document.getElementById('data-hint');
    const btnText = document.getElementById('btn-text');
    const btnStart = document.getElementById('btn-start');
    
    // Habilita o bot√£o agora que um modo foi selecionado
    btnStart.disabled = false;
    
    if (modo === 'reserva') {
        dataContainer.style.display = 'block';
        dataHint.textContent = 'Selecione a data desejada';
        btnText.textContent = '‚ö° Reservar Agora';
    } else {
        dataContainer.style.display = 'none';
        dataHint.textContent = 'Para amanh√£';
        btnText.textContent = 'ü§ñ Programar para Amanh√£ √†s 14h';
    }
}

function getChecked(name) {
    return Array.from(document.querySelectorAll(`#${name} input:checked`))
        .map(e => e.value);
}

function start() {
    if (!modoAtual) {
        alert("Selecione um modo de opera√ß√£o!");
        return;
    }
    
    const quadras = getChecked("quadras");
    const horarios = getChecked("horarios");
    
    if (!user.value || !senha.value || !matricula.value) {
        alert("Preencha usu√°rio, senha e matr√≠cula!");
        return;
    }
    
    if (quadras.length === 0 || horarios.length === 0) {
        alert("Selecione ao menos uma quadra e um hor√°rio!");
        return;
    }
    
    const payload = {
        user: user.value,
        senha: senha.value,
        matricula: matricula.value,
        quadras: quadras,
        horarios: horarios,
        modo: modoAtual
    };
    
    // Adiciona data se for modo reserva
    if (modoAtual === 'reserva' && data.value) {
        payload.data = data.value;
    }
    
    fetch("/start", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "erro") {
            alert(data.msg);
        }
    });
}

function cancel() {
    fetch("/cancel", {method: "POST"});
}

// Atualiza logs a cada segundo
setInterval(() => {
    fetch("/logs")
        .then(r => r.json())
        .then(data => {
            const logEl = document.getElementById('log');
            logEl.textContent = data.join("\n");
            logEl.scrollTop = logEl.scrollHeight;
        });
}, 1000);

// Define data de amanh√£ como padr√£o
const amanha = new Date();
amanha.setDate(amanha.getDate() + 1);
document.getElementById('data').value = amanha.toISOString().split('T')[0];
document.getElementById('consulta-data').value = amanha.toISOString().split('T')[0];

function toggleConsulta() {
    const section = document.getElementById('consulta-section');
    const icon = document.getElementById('toggle-icon');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        section.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

function consultarQuadras() {
    // Tenta usar as credenciais j√° preenchidas no formul√°rio principal
    let username = document.getElementById('user').value;
    let senha = document.getElementById('senha').value;
    
    // Se n√£o tiver, pede para preencher os campos extras
    if (!username || !senha) {
        const loginExtra = document.getElementById('login-extra');
        loginExtra.style.display = 'block';
        
        username = document.getElementById('consulta-user').value;
        senha = document.getElementById('consulta-senha').value;
        
        if (!username || !senha) {
            alert('Preencha usu√°rio e senha para consultar!');
            return;
        }
    }
    
    const data = document.getElementById('consulta-data').value;
    
    if (!data) {
        alert('Selecione uma data!');
        return;
    }
    
    const tabelaDiv = document.getElementById('tabela-quadras');
    tabelaDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">‚è≥ Buscando quadras...</p>';
    
    fetch('/consultar-quadras-public', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username: username, senha: senha, data: data})
    })
    .then(r => r.json())
    .then(data => {
        if (data.erro) {
            tabelaDiv.innerHTML = `<p style="color: #dc2626; padding: 20px;">‚ùå Erro: ${data.erro}</p>`;
            return;
        }
        
        if (data.tabela.length === 0) {
            tabelaDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Nenhuma reserva encontrada</p>';
            return;
        }
        
        let html = `
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 12px;">
                    <thead>
                        <tr style="background: #f3f4f6;">
                            <th style="padding: 8px 6px; text-align: center; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb; width: 50px;">Hora</th>
                            <th style="padding: 8px 6px; text-align: center; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb; width: 40px;">Quadra</th>
                            <th style="padding: 8px 6px; text-align: center; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb; width: 25px;"></th>
                            <th style="padding: 8px 6px; text-align: left; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb;">Respons√°vel</th>
                            <th style="padding: 8px 6px; text-align: left; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb;">P2</th>
                            <th style="padding: 8px 6px; text-align: left; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb;">P3</th>
                            <th style="padding: 8px 6px; text-align: left; font-size: 11px; color: #374151; font-weight: 600; border-bottom: 2px solid #e5e7eb;">P4</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.tabela.forEach(row => {
            // Define cor do status
            let statusColor = '#9ca3af'; // Cinza para Indispon√≠vel
            let statusEmoji = '‚ö´';
            
            if (row.status === 'Livre') {
                statusColor = '#10b981'; // Verde
                statusEmoji = 'üü¢';
            } else if (row.status === 'Reservado' || row.status === 'Ocupado') {
                statusColor = '#ef4444'; // Vermelho
                statusEmoji = 'üî¥';
            }
            
            html += `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 8px 6px; font-size: 12px; text-align: center; font-weight: 600;">${row.horario}</td>
                    <td style="padding: 8px 6px; font-size: 12px; text-align: center; font-weight: 600;">${row.quadra}</td>
                    <td style="padding: 8px 6px; text-align: center; font-size: 16px;" title="${row.status}">${statusEmoji}</td>
                    <td style="padding: 8px 6px; font-size: 12px;">${row.responsavel}</td>
                    <td style="padding: 8px 6px; font-size: 12px;">${row.participante2}</td>
                    <td style="padding: 8px 6px; font-size: 12px;">${row.participante3}</td>
                    <td style="padding: 8px 6px; font-size: 12px;">${row.participante4}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        tabelaDiv.innerHTML = html;
    })
    .catch(err => {
        tabelaDiv.innerHTML = `<p style="color: #dc2626; padding: 20px;">‚ùå Erro: ${err}</p>`;
    });
}
</script>
</body>
</html>